# 代码生成 & 更新规范 (goctl)

> 目的：统一团队在修改 `*.api` / `*.proto` 文件后的操作，避免生成代码遗漏或手动改错被覆盖。

## 总体原则
1. 任何对 API DSL (`*.api`) 或 RPC Proto (`*.proto`) 的结构性修改，必须立即执行对应的 goctl 生成命令。
2. 不直接手工编辑 goctl 标记为 `Code generated by goctl. DO NOT EDIT.` 的文件（`types/`、`handler/routes.go`、`internal/config` 等），业务逻辑写在 `logic/`、自定义中间件、或新的独立包里。
3. 生成前先提交/保存当前改动，便于比较差异 (`git diff`)；生成后再次提交，以保持演进轨迹清晰。
4. 版本锁定：目前使用 goctl 版本与仓库内已生成代码保持一致（示例：`goctl 1.8.3`）。若需升级，单独发起评审。 

## 环境准备
```bash
go install github.com/zeromicro/go-zero/tools/goctl@v1.8.3
# 确认版本
goctl -v
```

## API (REST) 代码生成
以用户服务为例：
```bash
# 可选：格式化 DSL，保证 diff 清晰
goctl api format -dir apps/user/api

# 生成（存在的文件会被保留；生成器会跳过已有业务逻辑文件）
goctl api go -api apps/user/api/user.api -dir apps/user/api -style gozero
```
其它服务（示例）：
```bash
# Chat API
goctl api go -api apps/chat/api/chat.api -dir apps/chat/api -style gozero
# Social API
goctl api go -api apps/social/api/social.api -dir apps/social/api -style gozero
```

### 修改路径命名的约定
- `@server ( prefix: v1/user )` 已提供层级，不要在具体路由再重复 `/user/` 前缀；例如：查询用户：`get /find`（而不是 `/user/find`）。
- 获取当前用户个人信息可以考虑统一成：`GET /me`（当前为 `/user`，后续若调整需同时改 DSL + regenerate）。

## RPC (Proto) 代码生成
进入对应 rpc 目录再执行（以用户服务为例）：
```bash
cd apps/user/rpc
# 生成 go、grpc、zrpc 服务端/客户端骨架
goctl rpc protoc user.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero
```
其它服务：
```bash
cd apps/chat/rpc && goctl rpc protoc chat.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero
cd apps/social/rpc && goctl rpc protoc social.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero
```

### 注意事项
- 修改 proto 中 message / service 名称后要重新生成；生成后若业务逻辑文件函数签名变化，需手动迁移旧逻辑。
- 避免在生成的 `internal/logic` 下直接改结构体字段（这些变化应来自 proto）。

## 生成后检查清单
| 检查项 | 说明 |
|--------|------|
| 编译是否通过 | `go build ./...` |
| 路由是否符合预期 | 检查 `routes.go` 新增/删除是否正确 |
| types 是否同步 | 新增入参/出参结构是否出现在 `internal/types/*.go` |
| 中间件是否仍被挂载 | DSL 中的 `middleware: JwtParse` 是否在生成代码里保留 |
| JWT/Redis 校验链未断裂 | 受保护路由仍在 `rest.WithJwt + WithMiddlewares` 组合下 |

## 与手写逻辑的边界
允许手写的目录 / 文件类型：
- `internal/logic/*` 中具体业务实现（生成器不会覆盖已存在逻辑文件）
- `internal/middleware/` 自定义中间件
- `pkg/` 下的共用库逻辑
- `deploy/`、`doc/`、`Makefile`、`README` 等文档与部署脚本

不建议手写或修改（除非同步到 DSL/Proto）：
- `types/*.go`
- `handler/routes.go`（路由调整回到 DSL 修改）
- `internal/config/*`

## 推荐 Makefile 片段
可在根 `Makefile` 加：
```makefile
GOCTL_VERSION=1.8.3

.PHONY: gen-user-api gen-user-rpc gen-im-api gen-im-rpc gen-social-api gen-social-rpc

gen-user-api:
	goctl api go -api apps/user/api/user.api -dir apps/user/api -style gozero

gen-user-rpc:
	cd apps/user/rpc && goctl rpc protoc user.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero

gen-chat-api:
	goctl api go -api apps/chat/api/chat.api -dir apps/chat/api -style gozero

gen-chat-rpc:
	cd apps/chat/rpc && goctl rpc protoc chat.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero

gen-social-api:
	goctl api go -api apps/social/api/social.api -dir apps/social/api -style gozero

gen-social-rpc:
	cd apps/social/rpc && goctl rpc protoc social.proto --go_out=. --go-grpc_out=. --zrpc_out=. -style gozero
```

然后：
```bash
make gen-user-api
make gen-user-rpc
```

## 常见问题 (FAQ)
| 问题 | 处理建议 |
|------|----------|
| 修改 DSL 后路由没变 | 确认执行了生成命令 & 查看是否有手工改动被缓存；必要时删除 `routes.go` 再生成（谨慎）|
| 生成器忽略文件 | goctl 会提示 `exists, ignored generation`，说明文件已存在且不会覆盖；若需重建删除后重跑 |
| 想批量重命名路由前缀 | 在 DSL 层统一调整 `@server ( prefix: ... )`，然后重新生成 |
| 引入新中间件未生效 | 确认 DSL 中声明 `middleware:` 并在 `ServiceContext` 初始化赋值 |

## 约定落地语句
> “凡涉及 *API DSL* (`*.api`) 或 *RPC Proto* (`*.proto`) 文件结构的修改，开发者必须在提交代码前运行对应的 goctl 生成命令并通过项目编译。”

---
如需后续把本规范合并进 `README.md` 或增加英文版本，可再提需求。
